rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow users to manage their own product configurations, credentials, and store settings
    match /users/{userId}/{path=**} {
      // This single rule covers:
      // - /users/{userId} (profile)
      // - /users/{userId}/products/{productId} (native products)
      // - /users/{userId}/productCategories/{categoryId} (categories)
      allow read, write: if request.auth.uid == userId;
    }

    match /userProductOptions/{userId}/{path=**} {
        allow read, write: if request.auth.uid == userId;
    }

    match /userWooCommerceCredentials/{userId} {
        allow read, write: if request.auth.uid == userId;
    }

    match /userShopifyCredentials/{userId} {
        allow read, write: if request.auth.uid == userId;
    }
    
    match /userStores/{userId} {
        allow read, write: if request.auth.uid == userId;
    }

    // --- Public Access Rules for Generated Stores ---

    // Allow public read for a specific user's native products
    // Used by the store's Product Listing Page (PLP)
    match /users/{userId}/products/{productId} {
      allow get: if true;
      // Keep write access restricted to the owner
      allow list, create, update, delete: if request.auth.uid == userId;
    }

    // Allow public read for a specific user's product options
    // Used by the store's Product Detail Page (PDP)
    match /userProductOptions/{userId}/products/{productId} {
        allow get: if true;
        // Keep write access restricted to the owner
        allow list, create, update, delete: if request.auth.uid == userId;
    }

    // Allow public read for a user's store configuration
    // Used by the store's header, footer, and layout components
    match /userStores/{userId} {
        allow get: if true;
         // Keep write access restricted to the owner
        allow list, create, update, delete: if request.auth.uid == userId;
    }
  }
}
